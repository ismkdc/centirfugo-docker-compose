version: "3.9"

services:
    redismaster:
        image: 'bitnami/redis'
        restart: always
        sysctls:
            net.core.somaxconn: 65365
        environment:
            - REDIS_REPLICATION_MODE=master
            - REDIS_PASSWORD=paswdd

    redisslave:
        image: 'bitnami/redis'
        restart: always
        sysctls:
            net.core.somaxconn: 65365
        depends_on:
            - redismaster
        environment:
            - REDIS_REPLICATION_MODE=slave
            - REDIS_MASTER_HOST=tasks.redismaster
            - REDIS_MASTER_PASSWORD=paswdd
            - REDIS_PASSWORD=paswdd
        deploy:
            replicas: 2

    redissentinel:
        image: 'bitnami/redis-sentinel'
        restart: always
        sysctls:
            net.core.somaxconn: 65365
        depends_on:
            - redismaster
            - redisslave
        environment:
            - REDIS_MASTER_HOST=tasks.redismaster
            - REDIS_MASTER_PASSWORD=paswdd
            - REDIS_PASSWORD=paswdd
        deploy:
            replicas: 3

    centrifugo:
        image: centrifugo/centrifugo:v3.2
        environment:
            - CENTRIFUGO_ENGINE=redis
            - CENTRIFUGO_REDIS_SENTINEL_ADDRESS=tasks.redissentinel:26379
            - CENTRIFUGO_REDIS_SENTINEL_MASTER_NAME=mymaster
            - CENTRIFUGO_REDIS_PASSWORD=paswdd
            - CENTRIFUGO_ADMIN_PASSWORD=123
            - CENTRIFUGO_ADMIN_SECRET=321
            - CENTRIFUGO_API_KEY=22
            - CENTRIFUGO_TOKEN_HMAC_SECRET_KEY=33
        command: centrifugo --admin
        ports:
            - 8000:8000
        ulimits:
            nofile:
                soft: 65535
                hard: 65535
        depends_on:
            - redismaster
            - redisslave
            - redissentinel
        deploy:
            replicas: 6
